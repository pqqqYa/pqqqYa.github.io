---
layout:     post
title:      "Proof Of Stake"
subtitle:   "PoS共识机制学习"
date:       2024-10-21 22:09:00
author:     "pqqqYa"
header-img: "img/post/2024-10-21-POS-bg.jpg"
catalog: true
tags:
    - 区块链
    - 共识机制
    - POS
    - 笔记
---


# 0. 术语表

**区块链**

字面意思理解区块链，区块链是指由一个一个包含数据的区块按照顺序连在一起的一条链。深入理解的话，区块链是借由密码学串接并保护内容的串连交易记录（又称区块）。

每一个区块包含了前一个区块的加密散列、相应时间戳记以及交易数据（通常用默克尔树算法计算的散列值表示），这样的设计使得区块内容具有难以篡改的特性。用区块链所串接的分布式账本能让两方有效纪录交易，且可永久查验此交易。

**区块链共识**

Consensus，通过密码学让分布式网络达成一致的一种算范，如PoW，PoS，DPoS

**PoW**

Proof of Work，工作量证明机制

**PoS**

Proof of Stake，股权证明机制

**Coin**

区块链网络中的基础货币，具有网络内交易、转账等基础功能。它是一种原生币，通常由网络上的矿工通过挖矿产生，并伴随着交易产生手续费。是区块链网络的基础为整个网络提供基本的交易和转账功能。

**Token**

区块链技术的一种可流通的数字资产，它可以代表各种权益、资产或服务的所有权，是基于Coin之上的附加价值。Token可以通过智能合约来发行，其具体规则由相应的项目方制定。

**Stake**

可以翻译为动词质押，在PoS共识中，通过Stake可以获得出块人权利，将Token进行Stake，意思就将Token抵押给系统的意思。


**硬分叉与软分叉**


软件的更新不向后做兼容。比如2013版本的word文件在2018版本的word里面是可以打开的，这种更新是做了向后兼容的，可以理解为是软分叉；如果不能打开，可以理解这个更新是一次硬分叉。

  

**最终确定性**


指区块信息无法被篡改，或者篡改可能性非常小


**Dapp**

去中心化应用，Decentralized Applications

  

**TPS**


每秒交易笔数（Transactions per second）

  

**Nothing at Stake**

  

无利害关系，指在PoS共识下，验证人作恶无风险的行为情况

  

**Slash**


削减/扣除，指PoS共识下，系统扣除验证人抵押金的行为


**矿工/验证人/出块人**


* 矿工：PoW共识中的节点维护人
* 验证人：PoS共识中的节点维护人，有些项目也叫出块人（Block Producer）

  

**ICO**

Initial Coin Offering 首次币发行

  

**Voting Power**

直译为投票权重，实际指的是通过Stake的代币占总量的比重。比如代币总量为1亿，1千万代币进行了Stake，那么整体的投票权重为10%，这10%可能分布在不同节点身上，和节点数量没有关系，很可能是5%分布在一个节点，其余5%分布在生态中其他100个节点中。


**Nonce**

在通信安全中，Nonce是一个在加密通信只能使用一次的数字

# 1. PoS介绍

  

## 1.1 什么是区块链共识


区块链是由一个一个块链接形成了块链条，每个新块生成（包含交易记录）都需要参与验证人的共同确认，这个共同确认的过程就是区块链共识。

主流的共识算法包括PoW（Proof of Work工作量证明），PoS（Proof of Stake 股权证明机制），BFT （拜占庭容错机制），Pool验证池，混合共识等，还有一些从主流基础上演变出来的共识算法，诸如PoA（Proof of Authorization授权证明机制），PoI（Proof of Importance重要性证明机制），DPoS （Delegate Proof of Stake股权证明机制），PBFT（Practical Byzantine Fault Tolerance使用拜占庭容错算法）等等。

## 1.2 什么是PoW-工作量证明

工作量证明是比特币等许多区块链网络所采用的共识算法。它的核心思想是要求矿工通过解决复杂的数学问题，来验证交易并将新区块添加到链中。解决这个问题的过程需要大量的计算能力，因此得名“工作量证明”。

PoW的工作原理是：每个节点通过执行哈希运算来争夺区块链上的下一个区块的记账权。哈希函数的特点是输入稍有变化，输出就会有很大的不同，这使得攻击者难以伪造。当节点找到一个满足特定条件的哈希值时，它就拥有了本次记账权，可以发布本轮需要记录的数据，其他节点验证后一起存储。

PoW的安全性在于其计算的困难性。哈希函数的特性使得计算出一个满足条件的哈希值非常耗时，而且随着计算能力的提升，难度也会随之增加。这意味着攻击者需要控制大量的计算能力才能发起攻击，这被称为51%攻击。然而，在实际操作中，攻击者要达到这个门槛非常困难，因此PoW被认为是一种相对安全可靠的共识算法。

PoW也存在一些缺点。最明显的是其能源消耗问题。由于计算哈希值需要大量的能源，以以太坊为例，在从PoW转向PoS后根据第三方的统计能源消耗较少超过99%，因此有人批评PoW对环境造成负面影响，也是因为这个原因PoW算法的区块链的挖矿行为在中国大陆现行法律中属于违法行为。此外，PoW还面临着可扩展性和公平性问题。由于每个节点都需要进行哈希运算，交易确认时间较长且难以提高交易效率，而且只有拥有足够计算能力的节点才能参与挖矿，这引发了对于资源公平分配的质疑。


## 1.3 **什么是PoS-股权证明机制共识**

  
权益证明是一种改进的共识算法，旨在解决PoW所面临的一些问题。与PoW不同，PoS不再依赖计算能力来争夺记账权，而是根据每个节点所占有的代币数量和时间来决定挖矿难度和权益。随着时间的推移，拥有更多代币的节点将有更大的机会成为下一个区块的验证者。

PoS的优点在于其能源效率更高。由于不再需要大量的计算能力来争夺记账权，能源消耗大大减少。此外，PoS还提高了可扩展性和公平性。由于验证者是根据其所占有的代币数量和时间来选择的，因此资源更加公平地分配给了所有节点。同时，由于减少了必要的手续和时间消耗,PoS也提高了交易的效率。


PoS共识中引入了Stake的概念，持币人将代币进行Staking，然后获得出块的机会，PoS共识中会通过选举算法，按照持币量比例，选出区块的矿工。矿工在指定区块高度（BlockHeight，区块的标号，本个区块与创世区块之间的块数）完成打包交易，生成新区块，并广播区块，广播的区块经过PoS共识中另外一道门槛，验证人，验证交易，通过验证后，区块得到确认。这样一轮PoS的共识过程就进行完成了。



# 2. PoS的发展

## 2.1 PoW+PoS

混合PoW+PoS共识是PoW过渡到PoS的一种过渡阶段。

## 2.2 纯PoS

纯PoS有更短的区块间隔，更合理的铸币方式，从而吸引了很多早期的人进来挖矿，甚至有很多专门做矿池的开始在论坛收币做验证人（Validator）。但是早期的PoS机制币种的案例也不少，原因大多在与PoS中Staking的激励太小，无法支持验证人的成本，还有就是去中心化的运行模式在PoS上的应用并不想PoW上那么完善。

## 2.3  委托PoS（DPoS）

比特股BitShares采用的区块链共识算法是权益授权证明Delegated Proof of Stake（简称DPoS），基于石墨烯（Graphene）平台搭建，这套石墨烯技术后来发展成了DPoS的专用底层，基于石墨烯开发的区块链项目可以直接使用DPoS的共识机制，免去了重复开发的苦恼，像Steemit，EOS，Lisk等都是基于石墨烯平台搭建的DPoS公链。

Graphene 是一个使用 DPOS 达成共识的区块链框架，但是对于现阶段来说，石墨烯区块链已经过时了。

## 2.4 BFT+PoS

拜占庭容错（Byzantine Fault Tolerance，简称BFT ）和PoS结合最早是在2014年由Tendermint团队提出。而Tendermint前身，则是基于1988年在麻省理工学院开发的经过验证的BFT算法（PBFT）。基于Tendermin的第一个项目是Cosmos项目。

BFT容错能给分布式网络带来了可观的抗风险能力，还能带来了较快的区块确认速度，解决区块链分叉问题，并带来一定程度的交易的最终确定性，间接的提高了性能。如果说纯PoS比起纯PoW，仅仅是解决了能源消耗，那么BFT+PoS比起纯PoS，那就是除了解决能源消耗外，还解决了PoW的交易确认，交易分叉，性能较低等问题。

Tendermint中很重要的一部分就是它的共识引擎部分（Tendermint Core），该共识引擎将BFT和PoS共识结合到了一起，持币人通过stake获得验证区块机会，签名完成后，新区块的验证通过3轮提交，2轮2/3的投票过程，来达成最终共识。由于投票是在区块广播后就开始的，那么当它完成了验证之后，新区块即获得了及时确定性（Instant Finality），这和比特币交易需要6个区块确认不一样，Tendermint大大缩短了验证时间，使得交易能及时生效，提前避免了交易被回滚，双花等问题的出现。

同时拜占庭容错最大能容忍系统中小于1/3的验证权重宕机，能很好的保证系统运行，可以简单理解为，只要系统中大部分人是诚实的，不管其他验证人怎么做，系统还能运行，不会出现停止，宕机的情况。

## 2.5 新一代PoS

Algorand专注于新的PoS+BFT共识算法（简称BA，Byzantine Agreement），旨在让验证人的选举更加随机，不可预测，以更好的保证系统的安全为研究方向

Thunderella旨在解决PoS当中的性能扩展问题

# 3. PoS的运行原理

PoS共识的运行有7个基本步骤
1. 运行节点
2. 注册成验证人
3. Stake
4. 选举验证人
5. 打包交易
6. 广播交易
7. 验证人确认

## 3.1 运行结点

区块链分布式账簿中的一个点，这个点（也就是运行节点的电脑），存储着区块链所有的交易记录即全结点运行（或相邻的部分节点的交易记录），并将参与到整个网络的共识当中去。所以电脑即充当了存储的功能，也充当着计算的功能。

在钱包配置完成后即可参与到PoS共识，即PoS挖矿中。按照不同的共识可以将拥有的挖矿权益委托给专业矿工，就可以参与到共识挖矿中去。

钱包（DeFi Wallet，Blockchain Wallet）由该项目所创立的加密货币交易所提供的去中心化金融钱包服务的名称。钱包允许通过去中心化交易所管理、交易、交换和使用加密货币。

初期的PoS项目基本都是全节点钱包客户端，其模拟的也是比特币初期可用电脑CPU挖矿的原理，运行节点的门槛也就是需要一台计算机。但全节点的缺点在于，随着区块数据的增多，会需要更多存储空间。同时，钱包客户端不能掉线，也就是不能关机，断网或者断电，否则无法运行节点来获得出块机会，已获得的出块机会在此种情况下也无法继续。

在这种情况下就发展出了矿池这种专业挖矿的机构，可以支持24小时，不断电，不停网的挖矿方式，普通用户如果不想自己守着电脑挖矿，可以将币发送给矿池，让矿池来帮助自己出块获得奖励。矿池通过收取一定的手续费来获得收入。，但是这种委托需要把币给到矿池手中，用户往往需要承担很大的风险，如果矿池失窃，或是卷款潜逃，用户往往一点办法都没有，需要极大的信任，还需要矿池维护人员有良好的职业操守。

另一种委托方式则是委托只是建立一种关系，而不需转移代币。用户发起委托，委托期间，但是仍然能支配自己的代币，极大的降低了非自愿运行节点用户Staking的成本。

## 3.2 声明为验证人

首先需要保证的就是验证人节点的配置符合项目的要求，验证人的配置要求要比全节点的配置要求要高。其次确认项目对验证人节点的一些硬性门槛，如持币量，锁定时间等。除了硬性要求，还有一些软性实力的要求，比如验证人需要时团队，或者公司，要求不能用云服务器，要求在社区有一定的声誉，要求投票需要达到一定的数量等等。

## 3.3 质押Stake

成为验证人之后，该验证人账户中的币会被检测，带有门槛的PoS共识会在此检测一些条件，当条件符合时，账户被标识为合格，然后放到验证人列表当中。如果不合格，此验证人并不会在真正的验证人列表里面。合格的验证人，其账户里面所有的币都是质押成为Staking的币，系统会计算该账户的Staking数量在总体Staking量中的占比，使用算法来选举每个区块的验证人。

但在一些项目中没有Stake的操作命令，只需要申请成为验证人的账号有代币，成为验证人之后，该账户的币就相当于默认Stake了。

## 3.4 选举验证人

系统会从候选的验证人列表当中选择出块人。选择出块人的算法有很多种，每种的优缺点都不一样，但是它们都有一个共同要保证的任务，那就是保证选举结果不能被操纵，不能被预测，防止Grind Attack的攻击发生。只有安全性足够高的算法，才能保证整个token的激励系统不会被单一方所控制。

以下列举几种目前比较流行的选举方式：

### Follow-the-Satoshi（FTS）

Follow-the-Satoshi算法，最早出现在论文《[Proof of Activity: Extending Bitcoin's Proof](https://eprint.iacr.org/2014/452.pdf)》中，其作用就是在PoA（Proof of Activity）共识当中选出出块人。

Satoshi这里的意思是聪，是比特币电子货币形式里，最小的计数单位，每个已被铸造出来的聪都对应一个UTXO（未经花费的输出Unspent Transaction Output），而每个UTXO都可以对应到一个私钥，而每一个私钥都可以对应到一个持有人。如果用持币权重（Voting Power）代替算力权重的话，PoS共识中的持币人其权重其实就是多个聪的集合的大小。

FTS 算法旨在从所有质押代币的总池中选择一个随机的Satoshi。由于每个质押的币都被分成许多Satoshi，因此用户拥有的币越多，他们控制的Satoshi就越多，从而增加他们被选中的机会。



在Tezos中对算法做了改良，因为聪的单位太小，随着系统锻造出来的聪越来越多，选择算法会变得低效，所以Tezos进行了规整，以10000XTZ为一个卷（Roll），将卷作为随机数选择的目标，以此来提高选择效率，包含选中最多的卷将成为块的出块人。同时，为了让随机数源变得不可预测，Tezos将4096个块当成一个选举周期（Cycle），利用上一个周期出块人披露的Nonce（在通信安全中，Nonce是一个在加密通信只能使用一次的数字）为随机数输入源。未披露的验证人将会被扣除抵押金。

Cardano的做法和Tezos类似，以一定区块数为选举周期（Epoch），每个周期有一个创世块，每个创世块中包含了每个块的出块人和一个随机种子p。和Tezos不同的是，Cardano每个块只有一个出块人，如果这个出块人掉线，这个块会被抛弃，直接进入下一个区块。而Tezos中单个块会有多个出块人，这些出块人会有不同的优先级，以避免备选出块人出现的种种情况。

### Round Robin


RR（Round Robin）常用于联盟链或者私有链居多，因为循环出块的可预知性太强，如果在一个可允许被随意进入（Pemissionless）的区块链网络里面，被攻击的概率会比较大，系统抗风险性变差。所以，在联盟链或者私有链的网络里面，各个节点互相知道/审核/同意（Pemission），利用RR既是一种简单可行的方式，又是一种高效的算法。

但是，后来有项目方改良了RR的算法，用于到Pemissionless的区块链网络中来确定出块人。在Multichain的[白皮书](https://www.multichain.com/download/MultiChain-White-Paper.pdf "https://www.multichain.com/download/MultiChain-White-Paper.pdf")中也有将RR算法运用到联盟链中的说明。

在EXONUM里面，RR的执行逻辑是，在一个高度H里面，所有出块人排列成一定的顺序（优先级），如果首位出块人掉线则直接跳过，第二位出块人代替首位出块人位置来出块，如果第二位出块人掉线，则排在第三位的出块人顶上，以此类推，由此得出循环算法的说法。在高度H+1里面，在H高度的出块人将不在获得出块机会，其出块权利会被锁定一定的周期F，只有等权利解锁后才会再次被加入的排序中来。

当然，每个高度H的出块人排序不能是固定的，那么会被攻击者找到攻击目标。所以每个高度H的顺序由算法得出，T = Hash(H) mod M!。可以确定每轮（Round），验证人的排序都不一样，这样就避免了相同顺序下，验证人合谋的低成本问题。

Cosmos同样使用了RR算法来进行验证人选举。Cosmos按照出块人的权重（Voting Power），来确定高度H下的出块人（Proposer），每个高度的第一个Proposer对出块进行提议，然后进入该高度H的第一个Round，其他验证人对该提议进行两轮投票（Prevote和Precommit），两轮都超过2/3通过，该区块被commit，成为高度为H+1的块。如果中间的任意议论投票中，有一轮的投票并没有达到2/3的权重（Voting Power），那么第一个Proposer的提议被否决，这进入第二个Proposer的提议阶段，提议重复第一个Proposer提议的流程，以此类推。

### DPoS

DPoS是由Daniel Lamier在2013年的比特股（Bitshares）上提出来的，其底层是基于石墨烯平台来搭建，其他的委托权益证明共识Delegate-PoS不在下文讨论之内。

基于石墨烯的DPoS，其出块人选举和RR算法有点像，更像是简单版本的RR。在DPoS的系统中，所有出块人由用户投票得出，投票最高的几位出块人获得出块机会。通常，出块人的数量是固定的，如EOS里面固定是21位，这21位出块人被投票出来之后，在一轮（126个块，每个出块人6个块）中，其出块顺序由15个及以上的生产者约定的顺序安排。

目前EOS的约定顺序是按照字母a-z排列的，比如Asia会比Basic排在前面出块，而Canada会在Basic后面出块。目前的这种排序方式，决定了每轮的排序其实有一样的顺序。

所以DPoS里面一个很基础的选举方式就是，系统规定一个固定数量的出块人，出块人由持币人投票得出，投票率按照高到低排序，系统按照高到低选择指定数量的出块人，然后将出块人随机排序，随机源可能是时间戳，也可以能出块人之间随机的参数。

### MPC多方计算（multiparty computation）

多方计算是由Cardano提出来的，目的是保证选举算法中的无偏差性，通过计算获得一个随机数，作为选举算法的输入。随机源计算出来后，选举算法仍然使用的是follow the satoshi的方法。

多方计算（multiparty computation (MPC) ）方法用来实现选举的随机性，每个参选人独立进行一次“投硬币”的行为，然后与其他参选人分享结果。这个想法就是：结果由每个参选人随机产生，但最终它们在相同的最终价值上达成一致。

Cadano使用的是类似于扔硬币的方案来决定区块人，分为3个阶段。提交，开启和恢复阶段。

在提交阶段，参选人通过私钥签名一个提交，并附上周期标号，公钥等信息，这个提交会被广播给其他参选人，每个参选人都可以拿到其他参选人的提交。

在开启阶段，参选人提交一个开启状态，这个状态带着一个值，可以解开第一步提交的数据。同样，每个人都可以拿到其他人的开启值。

最后恢复阶段，每个参选人相当于都拿到了所有的提交和开启，如果参选人中存在不诚实的人，那么很有可能有些不提交，或者不提交开启的情况出现，在这种情况下，诚实的选民可以张贴（上面有提到）来重建密钥，这个想法很简单：即使某些选民是对手，选举也能成功结束。每个诚实的参选人解出来的都是同一个密钥，也就是随机种子。

这就是Cardano多方计算的出来的结果。

### VRF

Verifiable random function (VRF) ，同样是计算随机元的一个方法，其应用代表是Algorand和Dfinity 。可验证的随机函数可以被视为密钥加密哈希的公钥模拟，以及对指数级数量的看似随机的位的加密承诺可验证随机函数的概念与可验证不可预测的函数 （VUF） 的概念密切相关，后者的输出难以预测，但不一定看起来是随机的。V



### 伪随机数源

随机数分为真随机数和伪随机数，真随机数是真是发生在现实中的随机事件产生的结果，比如扔硬币，扔骰子等等，伪随机数是用确定性的算法计算出来自`[0,1]`均匀分布的随机数序列，其实伪随机数并不是真正意义上的随机数。因为产生伪随机数是用确定的算法，那么只要是输入是一样的，那么输出肯定是一样的，也就意味着，输入源一旦被确定，那么输出是肯定会被知道的。

PoS出块人不能被提前被人预测出来，如果顺序能被知道，那么出块人提前勾结形成卡特尔组织，对系统是有一定危害的（在没有出现抵押金-抵扣的策略之前，这种攻击代价更小）。所以，PoS中的随机算法输入源显得非常非常重要。

在Tezos中，要求在下一个选举周期之前，该周期所有出块人必须披露一个Nonce，所有的Nonce会被收集到一个列表，通过Scrypt密钥衍生函数得出种子，该种子用于下个选择周期的随机种子输入源。

EOS中，在每个出块周期开始时，会根据持币人所投票数选出21个区块生产者。被选中的区块生产者的顺序会根据15个及以上的区块生产者的同意，制定出块顺序的安排。

在Cadona中，使用多方计算（multiparty computation (MPC) ）的方法来获取随机种子，简称扔硬币（Coin tossing）。简单来说就是这个方法模拟了现实中扔骰子的过程，来最终确定随机种子的生成，需要每个出块人都扔一次硬币得到一个随机数，然后互相分享扔硬币的结果，然后对所有结果进行种子生成，如果所有人都生成了一样的结果，那么说明大家互相使用了一样的结果。这就确认了种子生成。

Cadano和Tezos的随机种子生成很相似，只不过实现细节上有不一样。Cadano用多方计算保证了即使有人没有分享结果，也能通过部分结果恢复成整体。而Tezos要求每个出块人都批量Nonce，否则会被扣除抵押金（Slash）。相当于Cadano用了数学的方法解决了批量的问题，Tezos用了规则来限定，各有千秋了。

## 3.5 打包交易

轮到出块人出块的时候，出块人会从交易池里面挑选交易交易，并验证交易后，将其打包到区块中。验证的过程就是对交易做一些基本的判断，比如判断交易合不合法，签名是否正确，交易账户是否有足够的余额，交易是否已经被花出，交易数据大小是否已经超出限制等，不同PoS公有链对于交易的判断不同，验证的条件也不同。

  
从交易池子里面挑选交易，一般会有一个选择逻辑。该选择逻辑会参考两个因素，一个是交易手续费的大小，一个是发起交易的时间点。一般情况下，出块人的节点设置会优先选择手续费大的进行打包，同时系统也会设定一定参数，将交易时间点靠前的交易加入打包。当然，出块人还可以设置一些参数来调整打包程序，比如选择交易额大的，占内存空间小的等等，但是，不可以设置一些对地址交易的优先级，如果可以，那么该PoS机制的抗审查能力会被质疑。


## 3.6 广播交易

出块人将新区块生成后，会将区块数据广播到网络当中，为了让所有节点都把这些交易记录到自己的网络当中，这样全网维护的账本才能统一。网络中其他的节点会在不同的时间接收到广播的数据，新的节点会对打包数据进行进一步确认，并对其签名做认证，只有通过的验证数据对其进记录该节点本地所记录的账本当中。如果没有认证通过，那么节点将拒绝对其签名，同时，也不会将节点数据继续广播到其他节点中去。

  
广播通过点对点（Peer to Peer P2P）的网络进行传播。在点对点的网络当中，所有节点都是平等的，并且广播的传递并不会以物理地域为界限选择节点广播，而是会和网络中和自己连接的节点为传播，一传十，十传百，这样节点信息传播就会扩散开来。

虽然广播的传递不是以最近原则为基础，但是广播传播的速度会受到地域的影响，广播到达各个节点的时间并不一致，所以会出现一个数据同步问题。出块人通过节点A进行了广播，节点B在100ms后接受到了数据包，节点C则是在1000ms后接收到了数据包，这种延迟的时间间隔，会让整个网络有被攻击的机会出现，比如双花攻击、短程攻击等等，结果会影响交易的最终确定性，通常为了使得整个网络消灭延迟，通常交易的最终确定需要一定区块的时间确认。


## 3.7 验证人确认


PoS当中，矿工除了会出块外，还有充当验证人的角色。为了保证足够快的交易确认，每个区块的需要一定数量的验证人来进行签名确认，来保证其交易的合法性。


当前高度下，当出块人出块并广播后，被验证人接受到广播，紧接着对区块数据进行验证，在确认后用私钥签名，并继续广播出去。假设每个块需要10个签名，那么只有当网络中的所有的验证人都签名后，这个块才会被认为是最终的区块，并且填充到新的高度上来。

  
所以在出块人广播后，每个节点接收到广播，并维护这区块的一个中心状态，比如当系统只有1个签名的时候，节点并不能承认这个块是一个最终块，只有当该节点收到该区块新的签名更新，直到数量更新达到10的时候，该节点才会把区块写到最高的高度上来的。


为了保证签名的顺利性，整个区块的确认机制需要保证被提前选出来的验证人不会作恶，不在线或者有时间延迟等问题，可替代的解决方案有验证人备选，判断最小时间延迟，Slash作恶等。


在由节点所运行的PoS网络当中，每个节点运行的都是一个服务程序，这个程序会检测很多状态，以此来确认该区块的最终确定性。比如，检测是否有签名权利，检测是否可以替代签名，检测区块的最终签名状态等，不同的检测结果会触发接下来的很多操作，其目的都是为了保证整个区块链能顺利并且稳定的运行下去，不至于某个验证人不在线，整个网络崩溃的问题出现。



# 4. PoS中的性能与扩容


共识的扩容已经脱离BTC的本质，从PoW的共识改变到了PoS的共识，PoS共识带来了合作社形式的共识，让PoW矿工的竞争关系变成了合作，这让整个共识效率得到了非常大的提高。而另外一方面，由于PoW矿机出现了算力囤积，大量的算力被导向了单一矿池，去中心化程度大大降低，PoS共识的提出有助于解决中心化的问。

PoW的矿工通过同时计算一个哈希值，谁先计算出来谁就胜利的方式，获得共识，但也使得矿工之间浪费了不必要的能量，特别是时间。PoS的矿工通过选举算法的方式，随机轮流在指定时间确定出块，并达成共识，这种由系统决定的次序会比争夺位置获得机会的性能要优化很多。

  
与Master和Visa相比较，Visa的交易处理速度能达到65000TPS，而PoS公链项目平均也只有1000以内的TPS，这样的TPS针对分布式网络来说，已经算是比较高的，但是还是不能满足当今显示的商业需要。

  

  

## 4.1.侧链

侧链的解决办法是将非必要的计算放在侧链上计算，只把重要的状态同步到主链。按照Cardano的设计方案，主链由于承担着较为主要的价值传输，要设计的尽可能的简单，只有简单才能达到足够的安全，而不会因为代码太过于复杂审计不出bug，其他对安全不是更高优先级的计算，可以统一放到侧链上来计算，最后将侧链计算的结果同步到主链即可，这样很好的解决性能和安全的冲突问题，把三角问题放在了一个不同空间维度来解读。


## 4.1.zk-SNARKs

  

zk-SNARKs，一种新型的零知识验证（零知识验证就是验证：我能证明我知道问题答案，但却不用告诉你答案），简洁，不需要大量交互验证，不需要双方在线，相对于传统的验证方法，验证快，体积小。

对于大多数其他类型的证明，双方中至少有一方必须有权访问所有信息。可以将传统证明与用于访问在线网络的密码进行比较。用户提交密码，网络本身会检查密码的内容以验证密码是否正确。为此，网络还必须能够访问密码的内容。这种情况的零知识证明版本将涉及用户向网络证明（通过数学证明）他们拥有正确的密码，而无需实际透露密码本身。
  
通常区块链广播交易，需要所有验证人验证并签名后，才能确定为真（有些链的签名还不是最终确定性，Finality），这其中验证签名的过程耗时过长，导致性能受到影响。zk-SNARKs缩减的是验证过程，而不是人数，可以保证在去中心化的情况下，提高性能。


  



# 5. PoS中的激励与惩罚

  
去中心化所带来的成本需要激励来维护，但是由于PoW算力挖矿的方式，被PoS的权重挖矿方式所替代，意味着网络运行初期，就需要有足够的币来进行挖矿。同时，足够多的币才能像足够多的算力一样，更安全的保证去中心化的网络运行，那么PoS的激励不能像比特币一样，由剩余总量作为奖励，而是通过增发通胀作为激励了。

  
增发是PoS上最为常见的一种激励手段，常年保持一个比较合理的增发率，来激励矿工有足够多的动力维护网络。网络的初期发展特别重要，所以通常，线性改变的增发率会把初始值设置的足够大，以此来吸引更多的验证人。同时，这也作为吸引已存在代币参与到（Staking）网络中来验证区块。不参加网络安全验证的代币会被增发的代币稀释，即著名的PoS稀释性通胀的概念。

  

而后，增发率/通胀率会成为一个变化值，至于是多少合适，没有人能准确得出来。现在世界里面的货币政策，通常是伴随是通胀和紧缩同时发生的，在合适的时间使用合适的货币政策，是目前我们所能认识到的。比特币给我们带来的紧缩手段，PoS带来的通胀手段，都是区块链世界里面的一组实验。所以很多PoS公有链并没有把通胀率定死，而是初期定值，然后定价权交由社区定夺。

  
以太坊ETH把通胀率定在了年3%，Tezos和EOS把通胀率都定在了5%左右，Rchain把通胀率定在了7%，Cosmos把通胀率定在了7%~22%。目前来看，2019年要上主网的项目中，通胀率初始值都在5%~10%，看来是业界普遍的认同。


## 5.1.激励

  
PoS的激励和比特币的激励不一样，PoS是新增铸币（PoS的存量已经在初始分发时分发出去了，相当于一些PoW项目里面的预挖），比特币是存量铸币，所以PoS的通胀设计和比特币的存量分发设计有些许不同，造就了两种激励本质上的不一样。

PoS共识中，激励分为两个重要阶段

- 启动
- 去中心化

  
PoS网络启动之初的通胀设计，是PoS网络重中之重，为了防止初始Stake的不足，导致的攻击成本过低问题，初始的激励要足够大，吸引人们将代币进行Staking，否则，短程攻击可能会发生，交易激励可能会被篡改。一般情况下，启动主网时，开发团队会利用初始分发中留给自己的代币（一般是20%）先行Staking维护网络，同时禁止其他节点进入，在保证整个网络运行一段时间后，再开放给所有持币人。

  
而在网络顺利启动之后，去中心化又成为了一个重要的激励方向，为了防止大户更大的情况出现，很多项目会在奖励激励上做文章，比如单一节点的总量超过整体总量的1%时，超出部分将会的线性较少的奖励，或者不会获得奖励。比如有一个大户持币量1.2%，那么0.2%的量是获得不了奖励的。这样可以有效的控制PoS中的大户恒大的问题。

  
其次，很多PoS项目会致力于将节点出块，验证程序做得足够简单，依赖的设备随手可得，让持币人能简单的参与到项目Staking中来，也会使得项目更进一步的去中心化，而不会因为无技能，无设备而导致无法参与网络运行


PoS中的激励是通胀型的，通胀的比例作为参数被写到了创世区块中，作为可改参数，意味着社区有权利对通胀率进行修改，从而满足不同时代下的需求。区块链项目活的时间还不够长，所以这个数字目前还未曾被修改过。不同项目的通胀率会在一个范围内（2%~20%）浮动，初始值在5%~7%，或有线性减少或是线性增加的趋势，来保证合理性。

  

### 5.1.1 激励的具体行为

  

一般PoS公有链，为了维护网络不会暂停（Halt）或者是崩溃（Crash），会尽可能的激励出块人正确行为，同时会对不良行为给与惩罚。这和现实中正向引导，反向打击的逻辑是一样的。区块链的区块是按一定时间一个个接着形成并连在一起的，区块链的数据是保证正确并不能被修改的，所以我们可以看到一些具体被激励的行为，包括

- 出块（验证，打包交易）
- 签名（验证被打包的交易）
- 披露（披露用于生成出块人选举的随机数）
- 谴责（举报出块人不良行为）
- 在线（长期保持节点在线）
- 治理（参与链上治理行为）
  

### 5.1.2 激励不足

  
稳定的网络依赖于稳定的矿工群体以及稳定的代币参与（Stake），两者都依赖于系统代币对法币稳定的汇率，或者是说有不断上涨预期，这样才能让整个激励得以继续。
  

### 5.1.3 激励单一

  

激励不足的另外一面就是激励太单一，代币激励是一方面，另外一个方面是验证人获得奖励的机会。目前，提供给验证人获得奖励的主要机会就是出块和验证（不同的链有别的一些细微的机会设置），这和该验证人持有的币量权重或者是接受委托的币量权重是息息相关的，导致的结果就是验证人如果币量权重不够高，那么他获得的奖励是很少的。


## 5.2.惩罚

  

比特币里面对矿工是没有惩罚的，硬要说有惩罚，那就是矿工挖出来了孤块。孤块是比特币里面被抛弃的块，合法，工作量证明足够，只不过是因为广播速度或是计算问题等原因，并没有被大部分节点所接收到，而是被另外一个块替代了。挖出来的孤块是没有比特币奖励的，对应的矿工需要自己承担算力成本，所以竞争条件下，付出了算力却没得到奖励，也算是变相的一种惩罚。


而我在这里说的惩罚，是PoS中独有的惩罚机制，叫Slash，不同于PoW的惩罚。


PoS中的惩罚机制是用来惩罚PoS中矿工的不良行为的。具体的不良行为由不同的链自己决定，虽有不同，但大致都是一个原则，那就是保证系统稳定，任何尝试分叉，双签，和长期不在线的矿工，基本上都会被惩罚。当然，这里的惩罚不单单是和比特币一样的没有奖励，同时还会扣除出块人/验证人在系统里面交的抵押金，相当于是双重惩罚。


抵押金是PoS惩罚机制中独有的设计，抵押金的引入是解决PoS中多方面问题的一个综合解决方案。在PoS共识中，矿工由算法根据持币量权重选出，这些矿工在出块时，作恶的成本要比PoW小的多，因为可以无限制的出块，出多个块，签名分叉链等，不诚实的矿工会想尽办法作恶来获取更多的利益。


### 5.2.1 Slash


Slash作为PoS中解决网络安全的一个重要手段。Slasher可以被翻译为刽子手或者扣除人，Slash可以被翻译为削减（开支），或者意译为扣除抵押金。

PoS上一个重要的缺陷（Nothing at Stake），这种缺陷会导致链分叉，从而使得双花攻击成功的概率大大提高。区块链对分叉或者重复提交行为进行检测，一旦检测出来，该行为就会被惩罚（Slash），而惩罚的抵押金意味着Nothing at Stake变成Something at Stake。

Somethinh at Stake中的Something指的就是抵押金（bond、secure deposit），抵押金作为出块人出块的基础，诚实的出块人并不会害怕抵押金被扣除（Slash），因为他们不会去篡改程序，进行双花攻击，而不诚实的出块人因为抵押金可能会被扣除的可能性，动机减弱。


Slash的抵押金会被回收到系统中，不同系统对Slash的抵押金的处理不同，可以全部销毁（burn），或者把系统Slash的抵押金中的少部分给举报人，大部分销毁。还有一种设计就是一部分销毁，一部分流入基金会的统一池子，用于后续的社区/项目资助。
  
  

### 5.2.1 Slash的具体行为


Slash的对象是出块人，Slash的结果是抵押金被扣除，奖励也无法获得。不同系统对于Slash的行为不同，Slash的多少也不相同，下面列举一些Slash的具体行为。

  

- 双块：指在同一个高度下，一个出块人出多个块
- 双签：指在同一个高度下，一个验证人验证了不同链上上的块；或者指在同一高度下，一个验证人在一条链上的同一个块，签多次名


  
  

### 5.2.3 Slash的量

  

抵押金交多少合适？扣除抵押金的时候扣除多少合理？这涉及到一个计算问题，有两种算法：

  

1. 单块抵押，也就是只要是做涉及到奖励的行为的时候，就需要提前按比例交抵押金
2. 整体抵押，也就是在做涉及奖励的行为之前，用户的持币量是全部当成抵押金的。

  
在Slash发生的时候，第一种是扣除单个行为所交的所有抵押金，第二种是扣除全部抵押金的一部分，视情节严重程度来确定。


# 6.PoS中的矿工

  

矿工（miner），挖矿的人统称为矿工，这个概念沿用到了比特币里，但比特币里面的矿工挖的是比特币。矿工这个角色在比特币时代里被广泛传播开来，后在区块链时代开始有多种版本的叫法，比如铸币人（Minter），锻造人（Forger），验证人（Validator），面包师（Baker），背书人（Endorser）等等，但是实际的角色职责并没发生太大变化。


不同共识里面的矿工开始演化出新的权职。如PoW共识里面的矿工，如同比特币中矿工，矿工运行着系统编写好的软件，提供计算能力给系统，为系统工作，以此来获得奖励。PoS共识中的矿工，算力不再是最重要的需求，只需要一定的计算力，在合适的时间完成工作就可以获得奖励。


POS中的矿工除了创造新的区块外还会参与到Stake，验证，链上治理等中来，另外，和PoW矿工最大的不同点就是，PoS矿工不再需要一台高性能的矿机来和其他人竞争挖矿的权利了，与之对应的是，PoS矿工只需要运行一台足以满足系统最低配置的服务器，并且在系统被应用越广的时候，及时升级服务器配置，即可以完成PoS中对矿工的要求。


## 6.1.资格

  

PoS项目中的矿工资格，最基本的标准是持币。然后在持币量的基础上，各个项目的要求都有不同，以下列举目前项目中的一些条件

  
- 持币量需要10000个，或者占总量0.1%
- Staking量在前100，包括自持有量和委托量
- 币被锁仓200000个，锁仓时间1个月/半年/1年
- 节点服务器配置最低要求
- 软实力，社区名望，技术实力，7x24小时维护


其中各个网络对于持币量是必选项。持币量达到一定门槛是为了从某种程度上实现性能提升，而锁仓是为了让没有Bond-Slash的系统达到一定的安全（不排除项目锁币的流动性），而委托量的要求则是为了让大量无法参与网络验证的持币人参与网络维护。

  

## 6.2配置

  

一般系统对矿工的配置都不会很高，除非是运用拜占庭容错混合算法的项目或是趋向于联盟（Pemission）的项目。但是对于一个随意进入（Pemissionless）的区块链项目，一般的重点配置参数如下：

- 处理器（CPU）2核/4核
- 内存（Memory）4G
- 带宽（Bandwidth）5G bit
- 硬盘（Disk）200G及以上


其中，带宽要求要稍微高一点，因为一些区块链项目要求节点要长期在线，带宽高是为了和各个节点之间的通信保持正常。硬盘，是需要动态扩充的，随着区块数据的增多，出块节点需要保存完整的区块数据，所以硬盘容量不足时，需要及时扩充硬盘。

如果运行的节点对外暴露了RPC服务，对应的参数配置需要依据RPC服务的调用情况来决定。

  当然，项目初期和已经发展较为强大的项目需要的配置还不一样，后者配置需要还会更高一些，比如以太坊项目的参数配置如下（最低需求）


- 处理器（CPU）：2核
- 内存（Memory）：最小4GB内存，若使用HDD而不是SSD，则至少8GB
- 带宽（Bandwidth）：8+ MBit/sec
- 固态硬盘（SSD）：80GB

而以太坊推荐的配置应该是

- 处理器（CPU）：4核及以上
- 内存（Memory）：最小16GB内存
- 带宽（Bandwidth）：25+MBit/sec
- 固态硬盘（SSD）：500GB


服务器配置有两种方式可以选择


- 自建服务器--自己购买硬件服务器，连接电、网，运行服务
- 云服务器--购买现成的云服务器，动态配置参数，运行服务


云服务器的优点在于灵活，且成本低，大部分项目的矿工都采用的是云服务器。而自建服务器的成本短时间较高，而且需要7x24小时不断电，不断网，对环境要求较高，好处是一些服务支持可以直接用户自定义配置。目前，大部分节点还是搭在云服务器上，如亚马逊的AWS，Google的云服务，阿里的云服务等，这点为去中心化社区所诟病已久，因为所有的去中心化网络的节点服务仍然是搭建在世界的IT巨头手里。

  

## 6.3升级

  

节点运行的程序需要保持在正常的版本，要不然无法正常出块。很多更新是不会做旧版兼容的，所以需要节点及时的关注，节点运行的程序和其实和我们使用的APP一样，程序为了修复问题，增加新功能，会做更新，维护节点程序的团队会在合适的时机发布软件更新，但是这种更新不会像手机APP一样，主动发送更新推送。这个过程需要节点自己来发现，关注社区，或者自己做监控。

  
网络中，运行不同版本的节点程序可能会导致网络分叉，在比特币和以太坊上都发生过此类事情。像Bitcoincash比特现金币的分叉事件，其结果都是矿工运行了不同版本的节点软件。


在比特币的共识当中，没有机制来保证不分叉，只承认工作量最长的那条链。当网络中出现多个版本的程序时，意味着矿工之间出现了分歧。该分歧下，不同版本出来的块不兼容，矿工之间有权利拒绝将该块下载到本地中。那么比特币中就出现了多条分叉，而比特币会根据工作量来选择哪条链是最终链，没有得到大量算力支持的，会选择自立门户，来支持小算力的分叉链。

  
PoS中，由于涉及机制的不同，分叉变得不再容易，意味着企图通过运行不同版本的软件来完成分叉变得不可能，但是，PoS是允许矿工之间运行不同版本的程序的。除非是硬分叉，节点程序不兼容。同时，后来的PoS共识设计当中，都会检测节点版本的功能，当不兼容出现时，低版本的程序会被强制踢出选举队列，相当于不能参与选举出块了。


虽然PoS网络允许运行不同版本的程序，但是对于一个健康的区块链网络来说，所有节点及时更新版本是很有必要的，因为大多数的更新都是为了安全。

  

## 6.4硬件钱包

  

矿工出块的过程中，需要用到私钥签名，以证明这个块的出块人是自己。这个私钥存储在服务器中，节点程序会在需要的时候调用私钥并让其签名，但是节点服务器是暴露在网络当中的，一旦服务器被攻击，私钥有丢失的风险。

  

一般程序会对私钥进行加密后存储起来，并且尽可能少的调用私钥，就算调用私钥也是调用加密后的私钥，以防止服务器被攻击而丢掉私钥的情况。如在Tezos项目中，将节点声明为矿工时，需要输入15个助记词，并且用一个密码将其加密后再会存储到服务器当中，这样，即使被攻击，攻击者拿到的也是加密后的私钥，没有密码的情况下，私钥是解不出来的。

  如果项目方并有为矿工考虑这个加密，那么矿工需要自己来处理这个事情。现在最典型的做法就是使用硬件钱包对外输出签名。硬件钱包有很多品牌，目前比较知名的有Ledger，Trezor等，硬件钱包用户来存储用户私钥，签名的过程私钥并不接触网络，而是将私钥签名后的结果直接输出，这样可以保证私钥的安全性。


矿工使用硬件钱包用来签名，相当于给自己的资产加了一层保险，只要硬件钱包不丢失，一般情况是非常安全的。但是硬件钱包不好的一点就是，并不是所有的项目都支持硬件钱包的签名。


## 6.5问题


运行节点需要维护好服务器，这对一个团队来说是很重要的，因为一旦维护团队没有人和维护经验，那么碰到问题时没有及时解决的话，后果将会是极其糟糕的。

  

- 防止双签：指不能在同一个高度签署不同个块，双签会被系统Slash或者剥夺出块权利
- 时刻在线：7x24小时维护网络，断线断网都不可以，严格的系统会剥夺该节点的出块权利，设置是Slash
- 节点升级：指节点需要及时升级运行版本，以提升系统安全性
- 配置升级：指节点需要及时监控网络升级后对服务器的需求，特别是及时提高硬盘容量
- DDos攻击：指节点需要有足够的能力/架构防止网络中发起的DDos攻击
- 私钥存储架构：指节点需要专门的架构/程序来保证节点的私钥不会丢失
- 参与治理：指矿工需要及时参与到项目的治理生态，进行投票


## 6.6矿工的未来发展

  

矿工将会是去中心化网络中不可或缺的角色之一，目前验证设备的简单化和矿工群体的专业化逐渐显现。

  
首先，参与区块生成的机器配置会变得越来越低，从专业的服务器到电脑，甚至到手机都可以成为运行节点程序的机器，届时随时随地参与到区块链变得可能，同时，个体持币人Stake参与率也会增高，整个区块链世界更加的去中心化。

  
其次，大矿工群体会越来越倾向于专业化。因为有了委托权益的存在，更专业的矿工会接受到越来越多的委托，矿工有了专业性，维护整个区块链的同时，也可以更好的服务好整个所有委托用户。专业的矿工负责7x24小时的工作，同时会合理的分配奖励，委托用户因为得到好的服务，也更愿意参与到区块链中来。

# 7. PoS中的持币人

  

PoS共识把持币人带到了加密货币的舞台中央。他们不像PoW里的持币人，PoS的持币人成为了区块链真正的主人。PoS持币人可以主导或者参与到区块链的发展中来，享受与项目共同发展的红利，这是区块链共识从PoW到PoS过程中，持币人经历的最大的变化。

  

PoW里面，矿工来主导或者参与项目发展，矿工决定运行哪个节点程序，决定接受哪个块不接受哪个块。而PoS里，持币人本质是就是矿工（或者将矿工权利委托给代理矿工），所以PoS持币人可以决定自己项目的发展。


## 7.1 权利

  

PoS中持币人的权利主要是两个方向

  

1. 股权（Stake）
2. 投票（Vote）

  

区块链由一个一个块连成的一条链，而股权Stake后会被选举为出块人，出块人出新块来保护区块链的延续性，整个网络才会继续往前走。而投票决定的是整个区块链系统的参数设置，这些参数决定着整个网络的运行方向，像通胀率，像出块速度，像性能优化等等。
  
## 7.2 委托权利


持币人可以将手中的权利委托给矿工，矿工代替持币人Stak和投票，当然中间涉及到的出块奖励还有投票激励，矿工会把奖励中的大部分回报给持币人。

有项目支持多次委托，即A把权利委托给B，B又可以将该权利委托给C，C接收的委托权利为A+B，这样的好处就是权利委托变得更加灵活。


# 8. 链上治理


在PoS时代里面，治理权利从矿工回归到了持币人，持币人按照持币量拥有等量比例的系统权利，来参与整个社区的治理。


# 9. PoS目前存在的问题

  

PoS共识从提出时，本质上就是希望用持币人的Voting Power（投票权重）代替掉PoW里面的算力权重，来解决能源消耗问题，但是就是这么一个简单的初衷，把很多基于PoW共识设计的原则性平衡都打破了，PoS开始要面对由自己本身带来的各种问题。

## 9.1外部问题


### 9.1.1 分发

  

前面讲到过，PoW的分发是通过挖矿，比如BTC总量是2100万枚，以一个块N个BTC奖励的方式不断分发出去，这种分发相当于将BTC分发给了给这个网络做贡献的人，而且谁都可以来做贡献，在分发范围上并没有丛限制，同时BTC的2100万枚，以4年减半的速度降低分发，也在时间维度上给了参与人机会。PoS没有这种机制，所以PoS的分发就成为了问题。

  

### 9.1.2 参与度

  

PoS当中，需要有足够的代币进行Staking才能维护网络安全，因为Staking的量充当着系统中出块人被选择的重要因素。如果系统中的Staking量相当低，那么极有可能出现一个大户就几乎可以获得全部的出块机会（分发不均也会出现这样的问题），这样，一个网络就毫无去中心化可言，并且攻击网络变得极其简单，只要大户自己愿意，或者是外部因素直接攻击这个大户就可以了。


典型BFT+PoS的混合共识，加入了系统的容错程度，使得只要超过2/3的Stak拥有人是诚实的，那么系统就不会崩溃，任凭其余人怎么攻击。如果PoS代币分布比较分散的话，要求大量的代币参与到PoS共识中来Staking，将变得一件极其困难的事情。


现在很多纯PoS共识对Staking的处理办法就是：增发。用增发的代币去奖励为系统工作的节点，并还造出了一个概念，叫做是非稀释通胀。如果持币人想避免被增发的代币稀释，那么将持有的代币Stake到系统中，那么就有机会获得超过稀释率的价值。


通常情况下，100%代币Stake的情况下，Stake能获得的奖励比例和增发的比例是一样的，如果不到100%的代币Stake，那么获得的奖励比例会随着Staking的比例而变化。


### 9.1.3 激励问题

  

由参与度的问题引出来了激励的问题，天下没有免费的午餐。一个网络要变得健壮强大，离不开众人的维护。PoS的维护众人就是所有的持币人，激励更多持币人来维护网络，变成了PoS一项主要的使命。

  
和PoW不同，PoW是要激励更多的人，而非必须是持币人。这点造就了PoS上激励模型的不一样，加上现在越来越多的PoS项目加入了链上治理，希望持币人社区能来决策项目前进方向，使得投票激励变成了除区块激励外，另外一个比较重要的激励方向。同样的，还有像开发激励，社区大使激励，空投激励等等，越来越多的方向需要被激励，PoS的激励模型已经变得越来越复杂。

  
现在PoS项目的做法也各有不同，有通过增发覆盖全部激励的，有通过交易手续费抽成来覆盖部分激励的，还有通过抽成区块奖励来奖励部分工作的。这些治理方案就像是一个个国家，每个国家治理的政策都不一样，最终也导致了不一样的结果。



  

## 9.2 内部问题

  

### 9.2.1无利害攻击（Nothing at Stake）

  

Nothing at Stake是PoS上著名的攻击问题，我们都知道持币人通过Stake来参与PoS共识，获得出块机会。验证人在这个过程中执行了出块和验证两个动作，一般情况下，这两个动作合起来是一个铸币的过程，新的币会被奖励给验证人。


验证人为了获得足够多的奖励，会找更多的机会来出块和验证，其中，通过在分叉，并在新分叉上签名验证，是PoS早期一个非常好的尝试方式。无论哪条分叉链胜出，验证人都可以获得奖励，甚至获得双倍奖励，在PoS上发起这样的攻击，是没有成本的，只需要Stake。

  
Nothing at Stake中的Nothing指的就是这种无成本攻击攻击网络的情况，Nothing at Stake就可以理解为在Stake时没有成本的攻击网络。无利害攻击发生的概率是比较大的，因为不容易检测，所以很多验证人会暗地里尝试，但因为持币人的总体利益问题，大规模，成群的实际发生不太有可能。

  

一条链有频发的分叉攻击是恐怖的，所以很多方法前有币龄，后有Slash。币龄的方案成本太高，对Stake的意愿有所抑制，抵押金+Slash的方式非常好的解决了这个问题。验证人在做出块和验证时，需要向系统缴纳抵押金，如果系统检测出验证人的双签情况，验证人的抵押金将会被Slash。

  

对抵押件的Slash是比较严格的，这样可以有效抑制频繁发生的分叉攻击，保证系统稳定。

  

### 9.2.2长程攻击（Long Range Attack）

  

长程攻击指的是从创世区块开始，创建一条比原主链还要长的链，并篡改全部（部分）交易历史，来代替原来的主链，长程攻击也称作为覆盖历史攻击。


区别于短程攻击，长程攻击必须从创世区块开始构造交易，从中间点构造交易分叉链攻击称作为短程攻击。


长程攻击所利用的点在于，新加入的节点或者长期不在线的节点在同步新的区块数据时，并不能很清楚的知道哪条链是真正的主链，如果根据最长链原则来决定的话，很有可能出现真正的主链被篡位的情况，被修改了历史的主链变成了最长链，成为了新节点的同步接入点。长程攻击的制胜点在于，在分叉链生成的区块长度大于主链时，所有节点将会接受最长链的交易。

  
理论上，因为验证人在分叉链生成区块是没有代价的，而且是不需要等待时间，基于创世区块生成一条比主链还要长的链变得简单，唯一条件就是造出来的链比主链还要长，才能发起攻击，有很多理论都可以证明，但是实际操作很困难。


### 9.2.3简单攻击（Simple Attack）
  

简单攻击指的是分叉链在单位时间里面尽可能多的创造区块，以此来超过原主链长度所形成的攻击。在分叉链上，往往只有主导分叉的验证人一个，所以他完全可以忽略别人生成的区块，只生成自己的区块，并加快单位时间内自己区块的生成速度，那么分叉链的出块速度就有可能超过主链。

  

解决这种攻击的方法也很简单，用验证时间戳的方式来解决，对每个区块时间的时间戳进行验证，对于不合理的时间戳，比如同一时间里出现的多个区块，直接认定为不合理，进而决定哪条链是主链。

  

### 9.2.4变节攻击（Posterior Corruption）

  

变节攻击是比简单攻击更高级一点的攻击方式，变节攻击指的是分叉链验证人通过获得旧验证人的私钥，在分叉链上加速完成区块超越的一种攻击方式。

  
发展较长的区块链项目，可能已经更换了好几拨验证人，旧的验证人私钥依旧可以签署以前的旧区块，分叉链验证人通过购买，行贿或者破解的方式获得旧验证人的私钥，从而签署合理的区块，来达到加速的目的。


这种方案可以通过，用密钥演进加密技术（Key-Evolving Cryptography）和移动检查点技术（Moving Checkpoint）来解决，使用KEC的方式会让签名的私钥动态生成，旧私钥签名将不在可用，这可以有效阻止旧私钥被获得的情况发生。

  

### 9.2.5 权益流损（Stake Bleeding）

  

权益流损指的是分叉链验证人通过延长主链出块时间，同时通过累计分叉链权益，以加快分叉链出块速度的攻击方式。


一般分叉链上的验证人也是原主链上的验证人，当验证人在原主链上获得出块机会时，验证人会通过各种策略来延迟出块，甚至不出块，而分叉链上往往只有少数验证人，主导分叉的验证人可以获得大量出块机会，累计的权益又能加大其出块的几率，这样一慢一块，就可以达到赶超原主链的目的了


这种攻击可以通过采用移动检查点的策略来应对 ，在指定的区块高度设定检查点，并确定检查点之前的区块交易不可变，这样可以有效防止这样的策略。


  

### 9.2.6 短距离攻击/行贿攻击

  

短距离攻击是相对长距离攻击而言的，短距离攻击指的是对数日到数月不等跨度的区块进行重组，从而修改部分对自己有利的区块数据，达到攻击的目的。


举一个简单的例子，A购买商家B的一个商品，用代币支付后，商家B未等待区块确认，即让A拿走商品，完成交易。此时A立即贿赂网络中的大多数节点，让他们接受修改过后的交易记录，只要贿赂成本比商品价值低，那么攻击成功。


但在实际中，A贿赂多个PoS节点的操作可能性很小，只要节点分布足够分散，那么贿赂将变得极其困难。另外，如果有多个PoS节点的Staking权重较大，那么A只需要贿赂大权重的节点就可以了。商家B如果在等待安全确认后，再将商品给A，那么这种情况发生的可能性会变得小很多。

51%的概率攻击才有可能重改超过多个区块安全确认以上的历史数据，这个会在后文论述
  

### 9.2.7   51%Stak攻击

  

51%攻击源于PoW，全称为51%的算力攻击，意思是拥有超过51%算力的矿池，拥有修改或者重写旧历史的能力。在PoS里面，因为没有了算力，所以51%代表的就是51%的币量，其成本也从电力，机器变成了币值。

  
同样拥有51%攻击能力的情况下，在PoS中发起51%攻击要比PoW中的51%攻击要简单一点，因为不需要进行算力计算，拥有51%权重的验证人极有可能连续出块，那么伪造一条分叉链，包含了篡改数据的区块，替代原有的主链非常容易成功。只要发起攻击的成本比获利低，那么这种攻击就有操作空间。

  

实际上，51%这是一个相对值，并不是说只要到了51%的币量，发起攻击就一定成功，而是说51%是相对比较容易成功的，51%被选中出块的概率已经超过了半数，所以概率会比较高。当然，理论上，20%也有可能发起类似的攻击，并获得成功，但是这种可能性更低了。



  

### 9.2.8 卡特尔组织攻击（Cartel Attack）

  

Cartel是针对BFT拜占庭容错的体系来说。现在很多共识都采用了混合共识，特别是PoS+BFT的组合，BFT给系统带来了容错，抗风险能力提高了。

  

只要系统中超过2/3的人是诚实的，任凭其余人怎么作恶，怎么攻击网络，网络都可以稳定的运行。现存区块链项目，往往存在着因代币分布不均或者有钱人统一收购的情况，经常在各种项目中看到大户的存在，他们俩俩成群就可以达到1/3以上的持币量，甚至有些大户自己就拥有了超过1/3的持币量。

  

一些验证人为了获利，往往会和较大的持币人形成联盟，以达到系统的破坏门槛，这种组织我们称作为卡特尔组织，这种组织的攻击会让系统变得招架不住，或者停止出块，或者是网络崩溃，亦或是会在出块时拒绝某些交易等，结果是惨痛的。


### 9.2.8女巫攻击（Sybil Attack）

  

女巫攻击指的是攻击者通过大量生成节点，以拖慢整个网络，或者使用垃圾交易对整个网络发起攻击的方式。


这种攻击在PoS共识的公有链中比较容易发生，因为PoS共识当中不需要大量的硬件来获得算力，只需要运行节点程序就可以了，这样在PoS中就可以以非常低的成本，来创建大量的节点，完成对系统的攻击。


后来有了抵押金的方式后，这种攻击就能得到遏制。所有节点必须要拥有一定量的Stake才能获得出块机会，大量生成节点也需要大量的抵押金，这样的攻击并不会给攻击者带来很多的利益，所以女巫攻击在PoS共识中就很少存在了。


### 9.2.9 粉碎攻击（Grind Attack ）
  

粉碎攻击指的是攻击通过寻群系统选举算法偏好，使用或者联合计算资源让自己偏向被选中出块的攻击方式。
  

在熵未被引入PoS的验证人选举中之前，验证人可以通过模拟选举的方式，来找出系统偏向，从而利用自己的计算能力或者联合一部分验证人的计算能力，改变系统选举偏向，这种对PoS系统的攻击叫做是Grind Attack，也叫做是粉碎攻击。

  

比如，有大户控制一组了利益相关者，他们联合一起，尝试模拟协议执行，尝试不同的利益相关者参与者序列，来找到有利于对他们的操作方式， 这就是PoS当中所谓的磨损漏洞，这些验证人可以使用计算资源来操纵领导者选举。

  
解决粉碎攻击的方法就是尽可能的让验证人选举算法足够随机，保护好随机数源的生成方式，不能使用固定的生成方式，只要随机数源是足够随机的，此种攻击能预计到随机偏好是无意义的。

  

### 9.2.10 随机算法的攻击

  

理论上，验证人的选举算法都有被攻击的可能性，选举验证人的过程比较复杂，里面综合了多方面权重，也给与了攻击者可以下手的点。

在3.Pos的运行原理中列举了几个验证人选举算法，大多都是比较成熟的算法，想要直接成功攻击这些算法，难度较大，但一般情况下，这种攻击不难被发现，就算是被发现了也不好证明，所以这种攻击几乎无法追溯。

  

### 9.2.12 拒绝交易攻击（Transaction Denial Attacks）

  

拒绝交易攻击指的是攻击者针对某一个地址发起的攻击，致使其不能参与区块链网络的价值交换。

  
区块链网络本质上是一个点对点的价值网络（P2P），交易一旦广播，节点的无偏差性使得交易广播实际上被阻止的成功率很低很低，成功阻止的范畴我们可以转化为51%的攻击方式，这种攻击在PoW和PoS上都存在。


在交易被广播前，发起的拒绝交易攻击可能出现在任何轻节点SPV，或者使用其他全节点API的广播的钱包，交易所，或者是某些服务。当用户发起交易，提供服务的工具有可能通过审查用户的条件，来决定是否将用户的交易广播到P2P网络中。

  
解决办法是尽可能的使用全节点服务，特别是钱包。如果一定要选择轻节点，请选择社区比较信任的全节点作为接入点。

  

### 9.2.13 无法同步攻击（Desynchronization Attacks）

  

无法同步攻击指的是P2P网络中，攻击者攻击某些节点，让其无法和其他节点一样保持同步的攻击方式。

  
无法同步到最新区块的全节点钱包，会出现无法转账的情况。这种攻击的发起者可能是其他节点，因为这样攻击会使得被攻击节点无法获得预期收益，而且长期处于掉线，甚至会被Slash，这样发起攻击的节点就可以获得更高的被选举概率。

  
这种攻击可以分为内部攻击和外部攻击，外部攻击就是典型的DDoS攻击，在区块链不断同步新区块的时候，若服务器遭遇DDoS，那么节点服务器将无法同步情况；而内部攻击则是黑客直接hack进入服务器，可能导致节点服务器无法同步。

  
这两种攻击预防的方案也很多，和服务器的安全架构有关系，无法彻底杜绝，但是可以提高攻击代价，比如通过购买一些防护方案提高服务器的安全级别等。


# 11. 如何设计一个基于PoS共识的项目

基于PoS共识搭建去中心化项目，目前最简单的方式就是基于现在跨链项目直接搭建。开发成本较低的情况下，选择成熟的项目的SDK快速搭建一条具有PoS共识的侧链。另外一种，可以直接Fork石墨烯的底层，搭建和EOS一样的DPoS共识。这两种方案前者较为简单，后者稍微复杂，而且SDK的方案可能都不需要理解源代码，就可以快速搭建出来一条侧链，只需要关心选择SDK中哪些模块，或者抛弃哪些模块。
  
## 11.1 PoS共识

  

PoS共识发展到现在，有很多项目都进行过优化，有LPoS，BPoS，Ouroboros等，这些其实都是传统PoS共识的变种。选用开源共识进行修改会是一件省时省力，且有足够安全背书的选择，如果选择从零开始设计一个PoS共识，需要有极其严格的安全证明，来保证可用性和安全性，这对于一个没有科研背景的团队来说，其难度可想而知。


共识这种与密码学相关的科学，无法在短时间内被证明安全有效，最好是基于已有方案进行改造和优化，从零开始设计一个PoS共识所需要的时间，可能比设计整个项目的时间还要长，致力于发展应用生态的项目，花大量时间在设计新的共识，很可能会被拖死。所以现阶段设计一个好的PoS共识，最好还是基于现有共识来做优化。

  

## 11.2 初始代币分发

  
从目前使用的分发手段来看，有资助，有捐赠，有ICO，有私募，有IFO，有IEO，STO发展到现在已经趋向于发展成了股权+Token，资助和捐赠是过渡，ICO曾经是比较比较风靡的融资手段，但是由于ICO在个别国家有限制，所以这种融资手段有一定法律风险。

  

## 11.3 经济激励
  

经济激励对于一个去中心化的项目来说，相当于一种长期的治理措施。这种措施可以理解为国家的治理政策，只不过国家是根据当前形势作出判断，（如不同时期，国家出台的不同的货币政策）而去中心化的项目需要提前制定比较合理的，并且有高度适应性和调节性的逻辑，来满足未来5年，10年，甚至是上百年的发展。

  

现有的区块链项目都上线了线上治理功能，希望社区能及时通过治理调整策略，来指导当前发展，本质上和大国政策类似，只不过权利发生了转移。不过无论是提前制定还是实时的线上治理，本质上来说都是后置于现实的，这要求制定者在初期，就应该有一个全面的权衡。

  
去中心化项目的经济激励分为以下几个阶段：

  

### 11.3.1 网络启动

  

网络启动阶段，经济激励主要用于激励人们参与网络的维护中来，也就是吸引人们来当节点。在这个去中心化的世界当中，越多节点参与的网络被认为越具有去中心化精神，同时也在一定程度上代表了项目的热度情况。

  

作为节点参与到网络中，需要付出服务器成本，每个网络对于网络的要求都不相同，自然对节点服务器配置也不相同。


PoS当中一般会以通胀的形式来作为激励池，这个池子的通胀率在初始的时候可以设置比较高，依据代币总量来算，设置在5%~10%范围的项目居多。而在网络稳定后，将通胀缩减到1%是一些项目提出来的通胀解决方案。


### 11.3.2 网络运行

  

网络启动后，会进入到日常的网络运行阶段，运行阶段的奖励如果能随着系统功能开发完善，而多出来更多奖励，则对系统的安全运行有较大的帮助。

### 11.3.3 网络升级

  

一个网络除了日常的网络维护，还有不断优化网络，升级网络。吸收百家之所长，才能让项目保持足够的竞争力。


### 11.3.4 去中心化模型
  

去中心化是独立于性能和安全以外，另外一个重要的话题，去中心化程度是不可逆的。不可逆意味着，只要项目形成了中心化，再想让整个项目变得去中心化，基本是不可能的。

性能，安全都是可逆的，唯独去中心化是不可逆的。在设计之初，一定需要考虑好节点的门槛问题，起码在PoS上，持币是最低的门槛。硬件要求上，放宽对性能的要求是去中心化的一种体现，但是也需要考虑好，是否有别的技术方案让比较低配置的机器也能支持高交互性的性能。


### 11.3.5 治理方案


仅仅是把现实中的投票引入到区块链上来，是远远不够的。因为现实中的投票本来就有很多问题，动力不足，参与度不够，群投结果中庸等等，这些都是阻碍现实发展的一些问题。在设计全新的投票架构前，需要考虑这些问题，并结合PoS中代币权利的使用，给出合理的治理方案。

  

### 11.3.6 可持续发展

可持续资金决定了项目是否可以靠社区存活下去，治理决定了项目是否能让社区保持一致的初心，升级决定了项目是否拥有足够长久的竞争力，所以可持续发展是设计一个基于PoS项目的综合指标。只有站在整个设计外层看的时候，才可以考虑到一个大而全的可持续发展战略。



